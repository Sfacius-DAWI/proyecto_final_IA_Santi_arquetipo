---
description: 
globs: **/backend/**/*.ts
alwaysApply: false
---
# Mejores PrÃ¡cticas para Fastify + TypeScript

## ğŸ¯ VisiÃ³n General

Este conjunto de reglas define las mejores prÃ¡cticas para desarrollar APIs con Fastify y TypeScript, enfocÃ¡ndose en tipo-seguridad, rendimiento y mantenibilidad.

## ğŸš¨ REGLAS CRÃTICAS

1. ConfiguraciÃ³n Inicial
- SIEMPRE usar @fastify/type-provider-typebox
- DEFINIR esquemas con TypeBox
- HABILITAR strict mode en TypeScript

```typescript
// âœ… CORRECTO
import fastify from 'fastify';
import { TypeBoxTypeProvider } from '@fastify/type-provider-typebox';
import { Type } from '@sinclair/typebox';

const server = fastify().withTypeProvider<TypeBoxTypeProvider>();

// âŒ INCORRECTO
const server = fastify(); // Sin type provider
```

2. DefiniciÃ³n de Esquemas
- USAR TypeBox para schemas
- DEFINIR tipos de respuesta
- VALIDAR request bodies

```typescript
// âœ… CORRECTO
const UserSchema = Type.Object({
    id: Type.String({ format: 'uuid' }),
    name: Type.String(),
    email: Type.String({ format: 'email' }),
    age: Type.Number({ minimum: 0 })
});

type User = Static<typeof UserSchema>;

server.post('/users', {
    schema: {
        body: UserSchema,
        response: {
            201: UserSchema
        }
    }
}, async (request, reply) => {
    const user = request.body;
    // TypeScript conoce el tipo de user
    return user;
});

// âŒ INCORRECTO
server.post('/users', async (request) => {
    const user = request.body; // tipo any
    return user;
});
```

## ğŸ“ Estructura del Proyecto

```plaintext
src/
â”œâ”€â”€ plugins/
â”‚   â”œâ”€â”€ database.ts
â”‚   â””â”€â”€ auth.ts
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ users/
â”‚   â”‚   â”œâ”€â”€ schemas.ts
â”‚   â”‚   â”œâ”€â”€ handlers.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ products/
â”œâ”€â”€ services/
â”œâ”€â”€ types/
â””â”€â”€ utils/
```

## ğŸ”’ Plugins y Decoradores

1. DefiniciÃ³n de Plugins
- TIPOS explÃ­citos para opciones
- DECLARAR tipos para decoradores

```typescript
// âœ… CORRECTO
interface PluginOptions {
    prefix: string;
    timeout: number;
}

const myPlugin: FastifyPluginAsync<PluginOptions> = async (
    fastify,
    opts
) => {
    fastify.decorate('utilidad', (msg: string) => {
        return `Procesado: ${msg}`;
    });
};

// DeclaraciÃ³n de tipos para el decorador
declare module 'fastify' {
    interface FastifyInstance {
        utilidad: (msg: string) => string;
    }
}

// âŒ INCORRECTO
const myPlugin = async (fastify, opts) => {
    fastify.decorate('utilidad', (msg) => {
        return `Procesado: ${msg}`;
    });
};
```

## ğŸ›£ï¸ Rutas y Controladores

1. DefiniciÃ³n de Rutas
- SEPARAR schemas de handlers
- USAR tipos genÃ©ricos de Fastify
- IMPLEMENTAR rate limiting

```typescript
// âœ… CORRECTO
const routes: FastifyPluginAsync = async (fastify) => {
    fastify.route<{
        Body: typeof CreateUserSchema;
        Reply: typeof UserResponseSchema;
    }>({
        method: 'POST',
        url: '/users',
        schema: {
            body: CreateUserSchema,
            response: {
                201: UserResponseSchema
            }
        },
        handler: async (request, reply) => {
            const user = await createUser(request.body);
            return reply.code(201).send(user);
        }
    });
};

// âŒ INCORRECTO
fastify.post('/users', async (request, reply) => {
    const user = await createUser(request.body);
    return user;
});
```

## ğŸ”„ Hooks y Middleware

1. Hooks Tipados
- DEFINIR tipos para hooks
- USAR preValidation para autenticaciÃ³n
- IMPLEMENTAR error handling

```typescript
// âœ… CORRECTO
const authHook: preValidationHookHandler = async (request, reply) => {
    const token = request.headers.authorization;
    if (!token) {
        throw new Error('No autorizado');
    }
    const user = await validateToken(token);
    request.user = user;
};

// Tipos para request
declare module 'fastify' {
    interface FastifyRequest {
        user?: User;
    }
}

// âŒ INCORRECTO
const authHook = async (request, reply) => {
    const token = request.headers.authorization;
    request.user = await validateToken(token);
};
```

## ğŸ—ƒï¸ Manejo de Base de Datos

1. Conexiones y Queries
- USAR tipos para modelos
- IMPLEMENTAR connection pooling
- MANEJAR errores de DB

```typescript
// âœ… CORRECTO
interface DatabaseConfig {
    host: string;
    port: number;
    user: string;
    password: string;
    database: string;
}

const dbPlugin: FastifyPluginAsync<DatabaseConfig> = async (
    fastify,
    options
) => {
    const pool = await createPool(options);
    
    fastify.decorate('db', {
        async query<T>(sql: string, params?: unknown[]) {
            return pool.query<T>(sql, params);
        }
    });
};

// âŒ INCORRECTO
const db = await createPool({
    // configuraciÃ³n sin tipos
});
```

## ğŸ§ª Testing

1. Tests Tipados
- USAR light-my-request
- IMPLEMENTAR fixtures tipadas
- MOCK servicios externos

```typescript
// âœ… CORRECTO
describe('User API', () => {
    const app = buildTestServer();

    it('should create user', async () => {
        const response = await app.inject({
            method: 'POST',
            url: '/users',
            payload: {
                name: 'Test User',
                email: 'test@example.com'
            }
        });

        const user: User = response.json();
        expect(response.statusCode).toBe(201);
        expect(user.name).toBe('Test User');
    });
});
```

## ğŸ” Logging y Monitoreo

1. ConfiguraciÃ³n de Logger
- TIPOS para objetos de log
- NIVELES de log apropiados
- SERIALIZERS personalizados

```typescript
// âœ… CORRECTO
interface LoggerOptions {
    level: 'info' | 'error' | 'debug';
    prettyPrint: boolean;
}

const logger = fastify({
    logger: {
        level: 'info',
        serializers: {
            req(request) {
                return {
                    method: request.method,
                    url: request.url,
                    headers: request.headers
                };
            }
        }
    }
});

// âŒ INCORRECTO
const logger = fastify({
    logger: true
});
```

## ğŸ” Seguridad

1. Mejores PrÃ¡cticas
- IMPLEMENTAR rate limiting
- VALIDAR inputs
- MANEJAR CORS

```typescript
// âœ… CORRECTO
await fastify.register(import('@fastify/rate-limit'), {
    max: 100,
    timeWindow: '1 minute'
});

await fastify.register(import('@fastify/cors'), {
    origin: (origin, cb) => {
        const hostname = new URL(origin).hostname;
        if(hostname === "localhost"){
            cb(null, true);
            return;
        }
        cb(new Error("Not allowed"), false);
    }
});

// âŒ INCORRECTO
await fastify.register(import('@fastify/cors'), {
    origin: '*'
});
```

## ğŸ“ DocumentaciÃ³n

1. OpenAPI/Swagger
- GENERAR docs automÃ¡ticamente
- DOCUMENTAR schemas
- EJEMPLOS de uso

```typescript
// âœ… CORRECTO
const routes: FastifyPluginAsync = async (fastify) => {
    fastify.route({
        method: 'POST',
        url: '/users',
        schema: {
            description: 'Crear nuevo usuario',
            tags: ['users'],
            body: CreateUserSchema,
            response: {
                201: {
                    description: 'Usuario creado exitosamente',
                    type: 'object',
                    properties: {
                        id: { type: 'string', format: 'uuid' },
                        name: { type: 'string' }
                    }
                }
            }
        },
        handler: createUserHandler
    });
};
```

Este conjunto de reglas proporciona una base sÃ³lida para desarrollar APIs con Fastify y TypeScript. Â¿Hay alguna secciÃ³n especÃ­fica que te gustarÃ­a que expandiera o alguna duda particular?